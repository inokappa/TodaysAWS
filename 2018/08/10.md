# 2018/08/10 今日の AWS

## 今日の AWS ~ オブジェクトストレージ ~

### S3

#### 基本仕様

* S3 にデータを保存するには, 特定のリージョンのバケットと呼ばれる格納先を作成し, その中に Key-Value 形式でファイルをアップロードする
* バケット名は全世界で一意であること
* 各オブジェクトには URL が付与され, HTTPS によるアクセスが可能
* マルチパートアップロード機能を利用した場合, 1 オブジェクトあたり 5TB
* マルチマーとアップロード機能を利用しない場合, 1 オブジェクトあたり 5GB

#### ストレージクラス

* スタンダードクラス
    * 耐久性 99.999999999%
    * 3 ヶ所のデータセンターに複製される
* 低冗長化クラス
    * 耐久性 99.99%
    * 利用料金はスタンダードクラスと比較すると安価

### 整合性

* S3 は格納したデータを複数のデータセンターに複製することで高いデータ耐久性を実現している
* 但し, 書き込み, 更新, 削除時のデータの整合性について注意が必要となる

以下, オブジェクトに対するアクション毎にざっくりと整理.

| **オブジェクトに対するアクション** | **整合性の種類** | **メモ** |
|:---|:---|:---|
| 新規書き込み | 書き込み後の読み取り整合性 | アップロード直後は, オブジェクトにアクセス出来ないことがある |
| 上書き書き込み | 結果整合性 | 上書き後, オブジェクトにアクセスしても古いデータが返されることがある |
| 削除 | 結果整合性 | 削除後, 削除したはずのデータにアクセス出来ることがある |

### アクセス制限とセキュリティ

* アクセスコントロールリスト (ACL)
    * バケットとオブジェクトそれぞれについて, 読み取り, 書き込み許可を他の AWS アカウントに与えることが出来る
    * 条件付きアクセス許可, アクセス拒否設定は出来ない
    * 自アカウント内の IAM ユーザー, グループのアクセス権を制限することも出来ない
* バケットポリシー
    * 自アカウント内の IAM ユーザーやグループ, 他のアカウントのユーザーに対してアクセス許可を与えることが出来る
    * 条件付きアクセス許可やアクセス拒否を設定することも出来る
* IAM ポリシー
    * S3 へのアクセス許可を設定した IAM ポリシーを自アカウント内の IAM ユーザーやグループ, ロールに割り当てることが出来る
    * 条件付きアクセス許可やアクセス拒否を設定することも出来る
    * 他アカウントを指定したアクセス権は設定出来ない

その他, アクセス期間を限定した**署名 (期限) 付き URL**も設定可能.

### オブジェクトの暗号化とアクセスログ

* AWS が管理する鍵やユーザーが管理する鍵を使って S3 上で暗号化するサーバーサイド暗号化
* クライアント側で事前に暗号化したデータを S3 バケットにアップロードするクライアントサイド暗号化
* アクセスログはベストエフォートで記録される為, 完全性は保証されない, また, タイムラグが発生する

### 静的 Web サイトホスティング機能

* S3 は Web サイトをホスティング出来る
* 静的な Web サイトに限られる
* EC2 を利用するよりも運用の負荷がコストを抑えることが出来る
* 指定したドメイン名でアクセスさせる為には, Route53 等の DNS サービスにより名前解決が必要となる

### バージョニング機能

* バケット単位で指定可能
* オブジェクトの意図しない上書きや削除に対して有効 (操作前のオブジェクトを復元することが出来る)

### ライフサイクル機能と Glacier へのアーカイブ

* 通常はほとんどアクセスすることがないようなデータは Glacier に保存することで, データの保存コストを抑えることが出来る
* Glacier へのデータ保存は, ライフサイクル機能を利用するか, SDK を利用して直接格納する
* Glacier からデータを取り出す場合, 3 ~ 5 時間程度, Glacier に保存している 5% の容量まではデータ取り出し費用は無料
